package global.systemtypes["terraform:2.0"].library.provider.aws.rds.rds_cluster_iam_authentication_enabled.test_v1

import data.global.systemtypes["terraform:2.0"].library.provider.aws.rds.rds_cluster_iam_authentication_enabled.v1

test_iam_database_authentication_rds_cluster_good {
	accessible := true
	in := input_rds_cluster(accessible)
	actual := v1.prohibit_rds_clusters_with_disabled_iam_authentication with input as in
	count(actual) == 0
}

test_iam_database_authentication_rds_cluster_bad {
	accessible := false
	in := input_rds_cluster(accessible)
	actual := v1.prohibit_rds_clusters_with_disabled_iam_authentication with input as in
	count(actual) == 1
}

test_iam_database_authentication_rds_cluster_not_configured {
	accessible := null
	in := input_rds_cluster(accessible)
	actual := v1.prohibit_rds_clusters_with_disabled_iam_authentication with input as in
	count(actual) == 1
}

test_iam_database_authentication_rds_cluster_not_present {
	in := input_rds_cluster_missing_setting
	actual := v1.prohibit_rds_clusters_with_disabled_iam_authentication with input as in
	count(actual) == 1
}

input_rds_cluster(value) = x {
	x := {
		"format_version": "1.1",
		"terraform_version": "1.2.7",
		"planned_values": {"root_module": {"child_modules": [{
			"resources": [{
				"address": "module.sample_rds.aws_rds_cluster.default",
				"mode": "managed",
				"type": "aws_rds_cluster",
				"name": "default",
				"provider_name": "registry.terraform.io/hashicorp/aws",
				"schema_version": 0,
				"values": {
					"allow_major_version_upgrade": null,
					"availability_zones": [
						"us-west-1a",
						"us-west-1b",
						"us-west-1c",
					],
					"backtrack_window": null,
					"backup_retention_period": 5,
					"cluster_identifier": "aurora-cluster-demo",
					"copy_tags_to_snapshot": false,
					"database_name": "mydb",
					"db_cluster_instance_class": null,
					"db_instance_parameter_group_name": null,
					"deletion_protection": null,
					"enable_global_write_forwarding": false,
					"enable_http_endpoint": false,
					"enabled_cloudwatch_logs_exports": null,
					"engine": "aurora-mysql",
					"engine_mode": "provisioned",
					"engine_version": "5.7.mysql_aurora.2.03.2",
					"final_snapshot_identifier": null,
					"global_cluster_identifier": null,
					"iam_database_authentication_enabled": value,
					"iops": null,
					"master_password": "bar",
					"master_username": "foo",
					"preferred_backup_window": "07:00-09:00",
					"replication_source_identifier": null,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"scaling_configuration": [],
					"serverlessv2_scaling_configuration": [],
					"skip_final_snapshot": false,
					"snapshot_identifier": null,
					"source_region": null,
					"storage_type": null,
					"tags": null,
					"timeouts": null,
				},
				"sensitive_values": {
					"availability_zones": [
						false,
						false,
						false,
					],
					"cluster_members": [],
					"iam_roles": [],
					"restore_to_point_in_time": [],
					"s3_import": [],
					"scaling_configuration": [],
					"serverlessv2_scaling_configuration": [],
					"tags_all": {},
					"vpc_security_group_ids": [],
				},
			}],
			"address": "module.sample_rds",
		}]}},
		"resource_changes": [{
			"address": "module.sample_rds.aws_rds_cluster.default",
			"module_address": "module.sample_rds",
			"mode": "managed",
			"type": "aws_rds_cluster",
			"name": "default",
			"provider_name": "registry.terraform.io/hashicorp/aws",
			"change": {
				"actions": ["create"],
				"before": null,
				"after": {
					"allow_major_version_upgrade": null,
					"availability_zones": [
						"us-west-1a",
						"us-west-1b",
						"us-west-1c",
					],
					"backtrack_window": null,
					"backup_retention_period": 5,
					"cluster_identifier": "aurora-cluster-demo",
					"copy_tags_to_snapshot": false,
					"database_name": "mydb",
					"db_cluster_instance_class": null,
					"db_instance_parameter_group_name": null,
					"deletion_protection": null,
					"enable_global_write_forwarding": false,
					"enable_http_endpoint": false,
					"enabled_cloudwatch_logs_exports": null,
					"engine": "aurora-mysql",
					"engine_mode": "provisioned",
					"engine_version": "5.7.mysql_aurora.2.03.2",
					"final_snapshot_identifier": null,
					"global_cluster_identifier": null,
					"iam_database_authentication_enabled": value,
					"iops": null,
					"master_password": "bar",
					"master_username": "foo",
					"preferred_backup_window": "07:00-09:00",
					"replication_source_identifier": null,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"scaling_configuration": [],
					"serverlessv2_scaling_configuration": [],
					"skip_final_snapshot": false,
					"snapshot_identifier": null,
					"source_region": null,
					"storage_type": null,
					"tags": null,
					"timeouts": null,
				},
				"after_unknown": {
					"allocated_storage": true,
					"apply_immediately": true,
					"arn": true,
					"availability_zones": [
						false,
						false,
						false,
					],
					"cluster_identifier_prefix": true,
					"cluster_members": true,
					"cluster_resource_id": true,
					"db_cluster_parameter_group_name": true,
					"db_subnet_group_name": true,
					"endpoint": true,
					"engine_version_actual": true,
					"hosted_zone_id": true,
					"iam_roles": true,
					"id": true,
					"kms_key_id": true,
					"network_type": true,
					"port": true,
					"preferred_maintenance_window": true,
					"reader_endpoint": true,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"scaling_configuration": [],
					"serverlessv2_scaling_configuration": [],
					"storage_encrypted": true,
					"tags_all": true,
					"vpc_security_group_ids": true,
				},
				"before_sensitive": false,
				"after_sensitive": {
					"availability_zones": [
						false,
						false,
						false,
					],
					"cluster_members": [],
					"iam_roles": [],
					"master_password": true,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"scaling_configuration": [],
					"serverlessv2_scaling_configuration": [],
					"tags_all": {},
					"vpc_security_group_ids": [],
				},
			},
		}],
		"configuration": {
			"provider_config": {"module.sample_rds:aws": {
				"name": "aws",
				"full_name": "registry.terraform.io/hashicorp/aws",
				"version_constraint": "~> 4.0",
				"module_address": "module.sample_rds",
				"expressions": {"region": {"references": ["var.aws_region"]}},
			}},
			"root_module": {"module_calls": {"sample_rds": {
				"source": "../../../../../modules/rds",
				"module": {
					"resources": [{
						"address": "aws_rds_cluster.default",
						"mode": "managed",
						"type": "aws_rds_cluster",
						"name": "default",
						"provider_config_key": "module.sample_rds:aws",
						"expressions": {
							"availability_zones": {"constant_value": [
								"us-west-1a",
								"us-west-1b",
								"us-west-1c",
							]},
							"backup_retention_period": {"constant_value": 5},
							"cluster_identifier": {"constant_value": "aurora-cluster-demo"},
							"database_name": {"constant_value": "mydb"},
							"engine": {"constant_value": "aurora-mysql"},
							"engine_version": {"constant_value": "5.7.mysql_aurora.2.03.2"},
							"iam_database_authentication_enabled": {"constant_value": true},
							"master_password": {"constant_value": "bar"},
							"master_username": {"constant_value": "foo"},
							"preferred_backup_window": {"constant_value": "07:00-09:00"},
						},
						"schema_version": 0,
					}],
					"variables": {"aws_region": {
						"default": "us-west-2",
						"description": "AWS region",
					}},
				},
			}}},
		},
	}
}

input_rds_cluster_missing_setting := x {
	x := {
		"format_version": "1.1",
		"terraform_version": "1.2.7",
		"planned_values": {"root_module": {"child_modules": [{
			"resources": [{
				"address": "module.sample_rds.aws_rds_cluster.default",
				"mode": "managed",
				"type": "aws_rds_cluster",
				"name": "default",
				"provider_name": "registry.terraform.io/hashicorp/aws",
				"schema_version": 0,
				"values": {
					"allow_major_version_upgrade": null,
					"availability_zones": [
						"us-west-1a",
						"us-west-1b",
						"us-west-1c",
					],
					"backtrack_window": null,
					"backup_retention_period": 5,
					"cluster_identifier": "aurora-cluster-demo",
					"copy_tags_to_snapshot": false,
					"database_name": "mydb",
					"db_cluster_instance_class": null,
					"db_instance_parameter_group_name": null,
					"deletion_protection": null,
					"enable_global_write_forwarding": false,
					"enable_http_endpoint": false,
					"enabled_cloudwatch_logs_exports": null,
					"engine": "aurora-mysql",
					"engine_mode": "provisioned",
					"engine_version": "5.7.mysql_aurora.2.03.2",
					"final_snapshot_identifier": null,
					"global_cluster_identifier": null,
					"iops": null,
					"master_password": "bar",
					"master_username": "foo",
					"preferred_backup_window": "07:00-09:00",
					"replication_source_identifier": null,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"scaling_configuration": [],
					"serverlessv2_scaling_configuration": [],
					"skip_final_snapshot": false,
					"snapshot_identifier": null,
					"source_region": null,
					"storage_type": null,
					"tags": null,
					"timeouts": null,
				},
				"sensitive_values": {
					"availability_zones": [
						false,
						false,
						false,
					],
					"cluster_members": [],
					"iam_roles": [],
					"restore_to_point_in_time": [],
					"s3_import": [],
					"scaling_configuration": [],
					"serverlessv2_scaling_configuration": [],
					"tags_all": {},
					"vpc_security_group_ids": [],
				},
			}],
			"address": "module.sample_rds",
		}]}},
		"resource_changes": [{
			"address": "module.sample_rds.aws_rds_cluster.default",
			"module_address": "module.sample_rds",
			"mode": "managed",
			"type": "aws_rds_cluster",
			"name": "default",
			"provider_name": "registry.terraform.io/hashicorp/aws",
			"change": {
				"actions": ["create"],
				"before": null,
				"after": {
					"allow_major_version_upgrade": null,
					"availability_zones": [
						"us-west-1a",
						"us-west-1b",
						"us-west-1c",
					],
					"backtrack_window": null,
					"backup_retention_period": 5,
					"cluster_identifier": "aurora-cluster-demo",
					"copy_tags_to_snapshot": false,
					"database_name": "mydb",
					"db_cluster_instance_class": null,
					"db_instance_parameter_group_name": null,
					"deletion_protection": null,
					"enable_global_write_forwarding": false,
					"enable_http_endpoint": false,
					"enabled_cloudwatch_logs_exports": null,
					"engine": "aurora-mysql",
					"engine_mode": "provisioned",
					"engine_version": "5.7.mysql_aurora.2.03.2",
					"final_snapshot_identifier": null,
					"global_cluster_identifier": null,
					"iops": null,
					"master_password": "bar",
					"master_username": "foo",
					"preferred_backup_window": "07:00-09:00",
					"replication_source_identifier": null,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"scaling_configuration": [],
					"serverlessv2_scaling_configuration": [],
					"skip_final_snapshot": false,
					"snapshot_identifier": null,
					"source_region": null,
					"storage_type": null,
					"tags": null,
					"timeouts": null,
				},
				"after_unknown": {
					"allocated_storage": true,
					"apply_immediately": true,
					"arn": true,
					"availability_zones": [
						false,
						false,
						false,
					],
					"cluster_identifier_prefix": true,
					"cluster_members": true,
					"cluster_resource_id": true,
					"db_cluster_parameter_group_name": true,
					"db_subnet_group_name": true,
					"endpoint": true,
					"engine_version_actual": true,
					"hosted_zone_id": true,
					"iam_roles": true,
					"id": true,
					"kms_key_id": true,
					"network_type": true,
					"port": true,
					"preferred_maintenance_window": true,
					"reader_endpoint": true,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"scaling_configuration": [],
					"serverlessv2_scaling_configuration": [],
					"storage_encrypted": true,
					"tags_all": true,
					"vpc_security_group_ids": true,
				},
				"before_sensitive": false,
				"after_sensitive": {
					"availability_zones": [
						false,
						false,
						false,
					],
					"cluster_members": [],
					"iam_roles": [],
					"master_password": true,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"scaling_configuration": [],
					"serverlessv2_scaling_configuration": [],
					"tags_all": {},
					"vpc_security_group_ids": [],
				},
			},
		}],
		"configuration": {
			"provider_config": {"module.sample_rds:aws": {
				"name": "aws",
				"full_name": "registry.terraform.io/hashicorp/aws",
				"version_constraint": "~> 4.0",
				"module_address": "module.sample_rds",
				"expressions": {"region": {"references": ["var.aws_region"]}},
			}},
			"root_module": {"module_calls": {"sample_rds": {
				"source": "../../../../../modules/rds",
				"module": {
					"resources": [{
						"address": "aws_rds_cluster.default",
						"mode": "managed",
						"type": "aws_rds_cluster",
						"name": "default",
						"provider_config_key": "module.sample_rds:aws",
						"expressions": {
							"availability_zones": {"constant_value": [
								"us-west-1a",
								"us-west-1b",
								"us-west-1c",
							]},
							"backup_retention_period": {"constant_value": 5},
							"cluster_identifier": {"constant_value": "aurora-cluster-demo"},
							"database_name": {"constant_value": "mydb"},
							"engine": {"constant_value": "aurora-mysql"},
							"engine_version": {"constant_value": "5.7.mysql_aurora.2.03.2"},
							"iam_database_authentication_enabled": {"constant_value": true},
							"master_password": {"constant_value": "bar"},
							"master_username": {"constant_value": "foo"},
							"preferred_backup_window": {"constant_value": "07:00-09:00"},
						},
						"schema_version": 0,
					}],
					"variables": {"aws_region": {
						"default": "us-west-2",
						"description": "AWS region",
					}},
				},
			}}},
		},
	}
}
