package global.systemtypes["terraform:2.0"].library.provider.aws.autoscaling.launch_configuration_public_ip_disabled.test_v1

import data.global.systemtypes["terraform:2.0"].library.provider.aws.autoscaling.launch_configuration_public_ip_disabled.v1

test_launch_config_public_ip_disabled_good {
	associate_public_ip_address := false
	in := input_launch_config(associate_public_ip_address)
	actual := v1.prohibit_public_ip_launch_config with input as in
	count(actual) == 0
}

test_launch_config_public_ip_disabled_bad {
	associate_public_ip_address := true
	in := input_launch_config(associate_public_ip_address)
	actual := v1.prohibit_public_ip_launch_config with input as in
	count(actual) == 1
}

input_launch_config(associate_public_ip_address) := x {
	x := {
		"format_version": "1.1",
		"terraform_version": "1.2.7",
		"planned_values": {"root_module": {"child_modules": [{
			"resources": [
				{
					"address": "module.autoscaling.aws_autoscaling_group.asg",
					"mode": "managed",
					"type": "aws_autoscaling_group",
					"name": "asg",
					"provider_name": "registry.terraform.io/hashicorp/aws",
					"schema_version": 0,
					"values": {
						"capacity_rebalance": null,
						"context": null,
						"default_instance_warmup": null,
						"enabled_metrics": null,
						"force_delete": false,
						"force_delete_warm_pool": false,
						"health_check_grace_period": 300,
						"initial_lifecycle_hook": [],
						"instance_refresh": [],
						"launch_configuration": "tf-launchconf-styra",
						"launch_template": [],
						"load_balancers": null,
						"max_instance_lifetime": null,
						"max_size": 3,
						"metrics_granularity": "1Minute",
						"min_elb_capacity": null,
						"min_size": 1,
						"mixed_instances_policy": [],
						"name": "tf-asg-styra",
						"placement_group": null,
						"protect_from_scale_in": false,
						"suspended_processes": null,
						"tag": [],
						"tags": null,
						"target_group_arns": null,
						"termination_policies": null,
						"timeouts": null,
						"wait_for_capacity_timeout": "10m",
						"wait_for_elb_capacity": null,
						"warm_pool": [],
					},
					"sensitive_values": {
						"availability_zones": [],
						"initial_lifecycle_hook": [],
						"instance_refresh": [],
						"launch_template": [],
						"mixed_instances_policy": [],
						"tag": [],
						"vpc_zone_identifier": [],
						"warm_pool": [],
					},
				},
				{
					"address": "module.autoscaling.aws_launch_configuration.launch_conf",
					"mode": "managed",
					"type": "aws_launch_configuration",
					"name": "launch_conf",
					"provider_name": "registry.terraform.io/hashicorp/aws",
					"schema_version": 0,
					"values": {
						"associate_public_ip_address": associate_public_ip_address,
						"enable_monitoring": true,
						"ephemeral_block_device": [],
						"iam_instance_profile": null,
						"image_id": "ami-0849a313b038afda0",
						"instance_type": "m6a.large",
						"name": "tf-launchconf-styra",
						"placement_tenancy": null,
						"security_groups": null,
						"spot_price": null,
						"user_data": null,
						"user_data_base64": null,
						"vpc_classic_link_id": null,
						"vpc_classic_link_security_groups": null,
					},
					"sensitive_values": {
						"ebs_block_device": [],
						"ephemeral_block_device": [],
						"metadata_options": [],
						"root_block_device": [],
					},
				},
			],
			"address": "module.autoscaling",
		}]}},
		"resource_changes": [
			{
				"address": "module.autoscaling.aws_autoscaling_group.asg",
				"module_address": "module.autoscaling",
				"mode": "managed",
				"type": "aws_autoscaling_group",
				"name": "asg",
				"provider_name": "registry.terraform.io/hashicorp/aws",
				"change": {
					"actions": ["create"],
					"before": null,
					"after": {
						"capacity_rebalance": null,
						"context": null,
						"default_instance_warmup": null,
						"enabled_metrics": null,
						"force_delete": false,
						"force_delete_warm_pool": false,
						"health_check_grace_period": 300,
						"initial_lifecycle_hook": [],
						"instance_refresh": [],
						"launch_configuration": "tf-launchconf-styra",
						"launch_template": [],
						"load_balancers": null,
						"max_instance_lifetime": null,
						"max_size": 3,
						"metrics_granularity": "1Minute",
						"min_elb_capacity": null,
						"min_size": 1,
						"mixed_instances_policy": [],
						"name": "tf-asg-styra",
						"placement_group": null,
						"protect_from_scale_in": false,
						"suspended_processes": null,
						"tag": [],
						"tags": null,
						"target_group_arns": null,
						"termination_policies": null,
						"timeouts": null,
						"wait_for_capacity_timeout": "10m",
						"wait_for_elb_capacity": null,
						"warm_pool": [],
					},
					"after_unknown": {
						"arn": true,
						"availability_zones": true,
						"default_cooldown": true,
						"desired_capacity": true,
						"health_check_type": true,
						"id": true,
						"initial_lifecycle_hook": [],
						"instance_refresh": [],
						"launch_template": [],
						"mixed_instances_policy": [],
						"name_prefix": true,
						"service_linked_role_arn": true,
						"tag": [],
						"vpc_zone_identifier": true,
						"warm_pool": [],
					},
					"before_sensitive": false,
					"after_sensitive": {
						"availability_zones": [],
						"initial_lifecycle_hook": [],
						"instance_refresh": [],
						"launch_template": [],
						"mixed_instances_policy": [],
						"tag": [],
						"vpc_zone_identifier": [],
						"warm_pool": [],
					},
				},
			},
			{
				"address": "module.autoscaling.aws_launch_configuration.launch_conf",
				"module_address": "module.autoscaling",
				"mode": "managed",
				"type": "aws_launch_configuration",
				"name": "launch_conf",
				"provider_name": "registry.terraform.io/hashicorp/aws",
				"change": {
					"actions": ["create"],
					"before": null,
					"after": {
						"associate_public_ip_address": associate_public_ip_address,
						"enable_monitoring": true,
						"ephemeral_block_device": [],
						"iam_instance_profile": null,
						"image_id": "ami-0849a313b038afda0",
						"instance_type": "m6a.large",
						"name": "tf-launchconf-styra",
						"placement_tenancy": null,
						"security_groups": null,
						"spot_price": null,
						"user_data": null,
						"user_data_base64": null,
						"vpc_classic_link_id": null,
						"vpc_classic_link_security_groups": null,
					},
					"after_unknown": {
						"arn": true,
						"ebs_block_device": true,
						"ebs_optimized": true,
						"ephemeral_block_device": [],
						"id": true,
						"key_name": true,
						"metadata_options": true,
						"name_prefix": true,
						"root_block_device": true,
					},
					"before_sensitive": false,
					"after_sensitive": {
						"ebs_block_device": [],
						"ephemeral_block_device": [],
						"metadata_options": [],
						"root_block_device": [],
					},
				},
			},
		],
		"prior_state": {
			"format_version": "1.0",
			"terraform_version": "1.2.7",
			"values": {"root_module": {"child_modules": [{
				"resources": [{
					"address": "module.autoscaling.data.aws_ami.amazon_linux",
					"mode": "data",
					"type": "aws_ami",
					"name": "amazon_linux",
					"provider_name": "registry.terraform.io/hashicorp/aws",
					"schema_version": 0,
					"values": {
						"architecture": "x86_64",
						"arn": "arn:aws:ec2:us-west-2::image/ami-0849a313b038afda0",
						"block_device_mappings": [{
							"device_name": "/dev/xvda",
							"ebs": {
								"delete_on_termination": "true",
								"encrypted": "false",
								"iops": "0",
								"snapshot_id": "snap-0e91d5562d39fefca",
								"throughput": "0",
								"volume_size": "8",
								"volume_type": "gp2",
							},
							"no_device": "",
							"virtual_name": "",
						}],
						"boot_mode": "",
						"creation_date": "2022-12-16T01:56:14.000Z",
						"deprecation_time": "2024-12-16T01:56:14.000Z",
						"description": "Amazon Linux 2 AMI 2.0.20221210.1 x86_64 HVM gp2",
						"ena_support": true,
						"executable_users": null,
						"filter": [{
							"name": "name",
							"values": ["amzn2-ami-hvm-*-x86_64-gp2"],
						}],
						"hypervisor": "xen",
						"id": "ami-0849a313b038afda0",
						"image_id": "ami-0849a313b038afda0",
						"image_location": "amazon/amzn2-ami-hvm-2.0.20221210.1-x86_64-gp2",
						"image_owner_alias": "amazon",
						"image_type": "machine",
						"imds_support": "",
						"include_deprecated": false,
						"kernel_id": "",
						"most_recent": true,
						"name": "amzn2-ami-hvm-2.0.20221210.1-x86_64-gp2",
						"name_regex": null,
						"owner_id": "137112412989",
						"owners": ["amazon"],
						"platform": "",
						"platform_details": "Linux/UNIX",
						"product_codes": [],
						"public": true,
						"ramdisk_id": "",
						"root_device_name": "/dev/xvda",
						"root_device_type": "ebs",
						"root_snapshot_id": "snap-0e91d5562d39fefca",
						"sriov_net_support": "simple",
						"state": "available",
						"state_reason": {
							"code": "UNSET",
							"message": "UNSET",
						},
						"tags": {},
						"timeouts": null,
						"tpm_support": "",
						"usage_operation": "RunInstances",
						"virtualization_type": "hvm",
					},
					"sensitive_values": {
						"block_device_mappings": [{"ebs": {}}],
						"filter": [{"values": [false]}],
						"owners": [false],
						"product_codes": [],
						"state_reason": {},
						"tags": {},
					},
				}],
				"address": "module.autoscaling",
			}]}},
		},
		"configuration": {
			"provider_config": {"module.autoscaling:aws": {
				"name": "aws",
				"full_name": "registry.terraform.io/hashicorp/aws",
				"version_constraint": "~> 4.0",
				"module_address": "module.autoscaling",
				"expressions": {"region": {"references": ["var.aws_region"]}},
			}},
			"root_module": {"module_calls": {"autoscaling": {
				"source": "../../../../../modules/autoscaling",
				"module": {
					"resources": [
						{
							"address": "aws_autoscaling_group.asg",
							"mode": "managed",
							"type": "aws_autoscaling_group",
							"name": "asg",
							"provider_config_key": "module.autoscaling:aws",
							"expressions": {
								"launch_configuration": {"references": [
									"aws_launch_configuration.launch_conf.name",
									"aws_launch_configuration.launch_conf",
								]},
								"max_size": {"constant_value": 3},
								"min_size": {"constant_value": 1},
								"name": {"references": ["var.asg_name"]},
							},
							"schema_version": 0,
						},
						{
							"address": "aws_launch_configuration.launch_conf",
							"mode": "managed",
							"type": "aws_launch_configuration",
							"name": "launch_conf",
							"provider_config_key": "module.autoscaling:aws",
							"expressions": {
								"associate_public_ip_address": {"constant_value": true},
								"image_id": {"references": [
									"data.aws_ami.amazon_linux.id",
									"data.aws_ami.amazon_linux",
								]},
								"instance_type": {"references": ["var.instance_type"]},
								"name": {"references": ["var.launch_conf_name"]},
							},
							"schema_version": 0,
						},
						{
							"address": "data.aws_ami.amazon_linux",
							"mode": "data",
							"type": "aws_ami",
							"name": "amazon_linux",
							"provider_config_key": "module.autoscaling:aws",
							"expressions": {
								"filter": [{
									"name": {"constant_value": "name"},
									"values": {"constant_value": ["amzn2-ami-hvm-*-x86_64-gp2"]},
								}],
								"most_recent": {"constant_value": true},
								"owners": {"constant_value": ["amazon"]},
							},
							"schema_version": 0,
						},
					],
					"variables": {
						"asg_name": {
							"default": "tf-asg-styra",
							"description": "Name of the autoscaling group",
						},
						"aws_region": {
							"default": "us-west-2",
							"description": "AWS region",
						},
						"instance_type": {
							"default": "m6a.large",
							"description": "Type of the instance for launch configuration",
						},
						"launch_conf_name": {
							"default": "tf-launchconf-styra",
							"description": "Name of the launch configuration",
						},
					},
				},
			}}},
		},
		"relevant_attributes": [
			{
				"resource": "module.autoscaling.aws_launch_configuration.launch_conf",
				"attribute": ["name"],
			},
			{
				"resource": "module.autoscaling.data.aws_ami.amazon_linux",
				"attribute": ["id"],
			},
		],
	}
}
