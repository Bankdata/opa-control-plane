package global.systemtypes["terraform:2.0"].library.provider.aws.rds.publicly_accessible.test_v1

import data.global.systemtypes["terraform:2.0"].library.provider.aws.rds.publicly_accessible.v1

test_tf12_publicly_accessible_rds_good {
	accessible := false
	in := input_rds_instance_tf12(accessible)
	actual := v1.prohibit_publicly_accessible_db_instance with input as in
	count(actual) == 0
}

test_tf12_publicly_accessible_rds_bad {
	accessible := true
	in := input_rds_instance_tf12(accessible)
	actual := v1.prohibit_publicly_accessible_db_instance with input as in
	count(actual) == 1
}

input_rds_instance_tf12(value) = x {
	x := {
		"format_version": "0.1",
		"terraform_version": "0.12.20",
		"planned_values": {"root_module": {"resources": [{
			"address": "aws_db_instance.default",
			"mode": "managed",
			"type": "aws_db_instance",
			"name": "default",
			"provider_name": "aws",
			"schema_version": 1,
			"values": {
				"allocated_storage": 10,
				"allow_major_version_upgrade": null,
				"auto_minor_version_upgrade": true,
				"copy_tags_to_snapshot": false,
				"delete_automated_backups": true,
				"deletion_protection": null,
				"domain": null,
				"domain_iam_role_name": null,
				"enabled_cloudwatch_logs_exports": null,
				"engine": "mysql",
				"engine_version": "5.7",
				"final_snapshot_identifier": null,
				"iam_database_authentication_enabled": null,
				"instance_class": "db.t3.micro",
				"iops": null,
				"max_allocated_storage": null,
				"monitoring_interval": 0,
				"name": "mydb",
				"parameter_group_name": "default.mysql5.7",
				"password": "foobarbaz",
				"performance_insights_enabled": false,
				"publicly_accessible": value,
				"replicate_source_db": null,
				"restore_to_point_in_time": [],
				"s3_import": [],
				"security_group_names": null,
				"skip_final_snapshot": true,
				"storage_encrypted": null,
				"tags": null,
				"timeouts": null,
				"username": "foo",
			},
		}]}},
		"resource_changes": [{
			"address": "aws_db_instance.default",
			"mode": "managed",
			"type": "aws_db_instance",
			"name": "default",
			"provider_name": "aws",
			"change": {
				"actions": ["create"],
				"before": null,
				"after": {
					"allocated_storage": 10,
					"allow_major_version_upgrade": null,
					"auto_minor_version_upgrade": true,
					"copy_tags_to_snapshot": false,
					"delete_automated_backups": true,
					"deletion_protection": null,
					"domain": null,
					"domain_iam_role_name": null,
					"enabled_cloudwatch_logs_exports": null,
					"engine": "mysql",
					"engine_version": "5.7",
					"final_snapshot_identifier": null,
					"iam_database_authentication_enabled": null,
					"instance_class": "db.t3.micro",
					"iops": null,
					"max_allocated_storage": null,
					"monitoring_interval": 0,
					"name": "mydb",
					"parameter_group_name": "default.mysql5.7",
					"password": "foobarbaz",
					"performance_insights_enabled": false,
					"publicly_accessible": value,
					"replicate_source_db": null,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"security_group_names": null,
					"skip_final_snapshot": true,
					"storage_encrypted": null,
					"tags": null,
					"timeouts": null,
					"username": "foo",
				},
				"after_unknown": {
					"address": true,
					"apply_immediately": true,
					"arn": true,
					"availability_zone": true,
					"backup_retention_period": true,
					"backup_window": true,
					"ca_cert_identifier": true,
					"character_set_name": true,
					"db_subnet_group_name": true,
					"endpoint": true,
					"hosted_zone_id": true,
					"id": true,
					"identifier": true,
					"identifier_prefix": true,
					"kms_key_id": true,
					"latest_restorable_time": true,
					"license_model": true,
					"maintenance_window": true,
					"monitoring_role_arn": true,
					"multi_az": true,
					"option_group_name": true,
					"performance_insights_kms_key_id": true,
					"performance_insights_retention_period": true,
					"port": true,
					"replicas": true,
					"resource_id": true,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"snapshot_identifier": true,
					"status": true,
					"storage_type": true,
					"timezone": true,
					"vpc_security_group_ids": true,
				},
			},
		}],
		"configuration": {"root_module": {"resources": [{
			"address": "aws_db_instance.default",
			"mode": "managed",
			"type": "aws_db_instance",
			"name": "default",
			"provider_config_key": "aws",
			"expressions": {
				"allocated_storage": {"constant_value": 10},
				"engine": {"constant_value": "mysql"},
				"engine_version": {"constant_value": "5.7"},
				"instance_class": {"constant_value": "db.t3.micro"},
				"name": {"constant_value": "mydb"},
				"parameter_group_name": {"constant_value": "default.mysql5.7"},
				"password": {"constant_value": "foobarbaz"},
				"publicly_accessible": {"constant_value": value},
				"skip_final_snapshot": {"constant_value": true},
				"username": {"constant_value": "foo"},
			},
			"schema_version": 1,
		}]}},
	}
}
