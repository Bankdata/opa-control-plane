cases:
- note: config without git
  config: |
        {
          systems: {
            TestSystem: {
              object_storage: {
                aws: {
                  url: {{ .s3_url }},
                  bucket: test,
                  key: bundle.tar.gz,
                  region: mock-region,
                }
              },
              datasources: [
                {
                  name: "datasource1",
                  path: "datasource1",
                  type: "http",
                  config: {
                    url: {{ .http_url }}/datasource1
                  }
                }
              ],
              files: {
                "app/app.rego": {{ base64encode .app_rego }},
                "foo.rego": {{ base64encode .foo_rego }}
              },
              requirements: [
                {library: TestLibrary}
              ]
            }
          },
          libraries: {
            TestLibrary: {
              datasources: [
              {
                  name: "datasource2",
                  path: "datasource2",
                  type: "http",
                  config: {
                    url: {{ .http_url }}/datasource2
                  }
                }
              ],
              files: {
                "bar.rego": {{ base64encode .bar_rego }},
                "lib/lib.rego": {{ base64encode .lib_rego }}
              }
            }
          }
        }
  content_parameters:
    app_rego:         "package app\np := data.lib.q"
    bar_rego:         "package lib\ns := true"
    foo_rego:         "package foo"
    lib_rego:         "package lib\nq := data.lib.s"
    datasource1_json: '{"key": "value1"}'
    datasource2_json: '{"key": "value2"}'
  http_endpoints:
    /datasource1: "{{ .datasource1_json }}"
    /datasource2: "{{ .datasource2_json }}"
  expected_filesystem: 
  - "/files/651b945976b07287063e8967060724a4/app/app.rego" # system
  - "/files/651b945976b07287063e8967060724a4/datasource1/data.json"
  - "/files/651b945976b07287063e8967060724a4/foo.rego"
  - "/files/dd60a95cf9945e13a93d823fed9753ed/bar.rego" # library
  - "/files/dd60a95cf9945e13a93d823fed9753ed/datasource2/data.json"
  - "/files/dd60a95cf9945e13a93d823fed9753ed/lib/lib.rego"
  expected_bundle:
    rego:
      app/app.rego: "{{ .app_rego }}"
      bar.rego:     "{{ .bar_rego }}"
      foo.rego:     "{{ .foo_rego }}"
      lib/lib.rego: "{{ .lib_rego }}"
    data: |
        {
          "datasource1": {{ .datasource1_json }},
          "datasource2": {{ .datasource2_json }}
        }