package global.systemtypes["terraform:2.0"].library.provider.aws.ec2.whitelist_subnets.test_v1

import data.global.systemtypes["terraform:2.0"].library.provider.aws.ec2.whitelist_subnets.v1
import data.library.parameters

test_ec2_whitelist_subnets_good {
	in = input_ec2_with_subnet("subnet-ABC")
	p := {"allowed_subnets": {"subnet-ABC", "subnet-XYZ"}}

	actual := v1.ec2_whitelist_subnets with input as in
		with data.library.parameters as p

	count(actual) == 0
}

test_ec2_whitelist_subnets_bad {
	in = input_ec2_with_subnet("subnet-MNO")
	p := {"allowed_subnets": {"subnet-ABC", "subnet-XYZ"}}

	actual := v1.ec2_whitelist_subnets with input as in
		with data.library.parameters as p

	count(actual) == 1
}

test_ec2_whitelist_subnets_bad {
	in = input_ec2_without_subnet
	p := {"allowed_subnets": {"subnet-ABC", "subnet-XYZ"}}

	actual := v1.ec2_whitelist_subnets with input as in
		with data.library.parameters as p

	count(actual) == 1
}

input_ec2_with_subnet(subnet_id) = x {
	x := {
		"format_version": "1.1",
		"terraform_version": "1.2.7",
		"planned_values": {"root_module": {"child_modules": [{
			"resources": [{
				"address": "module.ec2.aws_instance.unapproved_subnet",
				"mode": "managed",
				"type": "aws_instance",
				"name": "unapproved_subnet",
				"provider_name": "registry.terraform.io/hashicorp/aws",
				"schema_version": 1,
				"values": {
					"ami": "ami-0747bdcabd34c712a",
					"credit_specification": [],
					"get_password_data": false,
					"hibernation": null,
					"instance_type": "t2.micro",
					"launch_template": [],
					"source_dest_check": true,
					"subnet_id": subnet_id,
					"tags": {"Name": "unapproved_subnet"},
					"tags_all": {"Name": "unapproved_subnet"},
					"timeouts": null,
					"user_data_replace_on_change": false,
					"volume_tags": null,
				},
				"sensitive_values": {
					"capacity_reservation_specification": [],
					"credit_specification": [],
					"ebs_block_device": [],
					"enclave_options": [],
					"ephemeral_block_device": [],
					"ipv6_addresses": [],
					"launch_template": [],
					"maintenance_options": [],
					"metadata_options": [],
					"network_interface": [],
					"private_dns_name_options": [],
					"root_block_device": [],
					"secondary_private_ips": [],
					"security_groups": [],
					"tags": {},
					"tags_all": {},
					"vpc_security_group_ids": [],
				},
			}],
			"address": "module.ec2",
		}]}},
		"resource_changes": [{
			"address": "module.ec2.aws_instance.unapproved_subnet",
			"module_address": "module.ec2",
			"mode": "managed",
			"type": "aws_instance",
			"name": "unapproved_subnet",
			"provider_name": "registry.terraform.io/hashicorp/aws",
			"change": {
				"actions": ["create"],
				"before": null,
				"after": {
					"ami": "ami-0747bdcabd34c712a",
					"credit_specification": [],
					"get_password_data": false,
					"hibernation": null,
					"instance_type": "t2.micro",
					"launch_template": [],
					"source_dest_check": true,
					"subnet_id": subnet_id,
					"tags": {"Name": "unapproved_subnet"},
					"tags_all": {"Name": "unapproved_subnet"},
					"timeouts": null,
					"user_data_replace_on_change": false,
					"volume_tags": null,
				},
				"after_unknown": {
					"arn": true,
					"associate_public_ip_address": true,
					"availability_zone": true,
					"capacity_reservation_specification": true,
					"cpu_core_count": true,
					"cpu_threads_per_core": true,
					"credit_specification": [],
					"disable_api_stop": true,
					"disable_api_termination": true,
					"ebs_block_device": true,
					"ebs_optimized": true,
					"enclave_options": true,
					"ephemeral_block_device": true,
					"host_id": true,
					"host_resource_group_arn": true,
					"iam_instance_profile": true,
					"id": true,
					"instance_initiated_shutdown_behavior": true,
					"instance_state": true,
					"ipv6_address_count": true,
					"ipv6_addresses": true,
					"key_name": true,
					"launch_template": [],
					"maintenance_options": true,
					"metadata_options": true,
					"monitoring": true,
					"network_interface": true,
					"outpost_arn": true,
					"password_data": true,
					"placement_group": true,
					"placement_partition_number": true,
					"primary_network_interface_id": true,
					"private_dns": true,
					"private_dns_name_options": true,
					"private_ip": true,
					"public_dns": true,
					"public_ip": true,
					"root_block_device": true,
					"secondary_private_ips": true,
					"security_groups": true,
					"tags": {},
					"tags_all": {},
					"tenancy": true,
					"user_data": true,
					"user_data_base64": true,
					"vpc_security_group_ids": true,
				},
				"before_sensitive": false,
				"after_sensitive": {
					"capacity_reservation_specification": [],
					"credit_specification": [],
					"ebs_block_device": [],
					"enclave_options": [],
					"ephemeral_block_device": [],
					"ipv6_addresses": [],
					"launch_template": [],
					"maintenance_options": [],
					"metadata_options": [],
					"network_interface": [],
					"private_dns_name_options": [],
					"root_block_device": [],
					"secondary_private_ips": [],
					"security_groups": [],
					"tags": {},
					"tags_all": {},
					"vpc_security_group_ids": [],
				},
			},
		}],
		"configuration": {
			"provider_config": {
				"module.ec2:aws": {
					"name": "aws",
					"full_name": "registry.terraform.io/hashicorp/aws",
					"version_constraint": "~> 4.0",
					"module_address": "module.ec2",
					"expressions": {"region": {"references": ["var.aws_region"]}},
				},
				"module.ec2:aws.east": {
					"name": "aws",
					"full_name": "registry.terraform.io/hashicorp/aws",
					"alias": "east",
					"version_constraint": "~> 4.0",
					"module_address": "module.ec2",
					"expressions": {"region": {"constant_value": "us-east-1"}},
				},
			},
			"root_module": {"module_calls": {"ec2": {
				"source": "../../../../../modules/ec2",
				"module": {
					"resources": [{
						"address": "aws_instance.unapproved_subnet",
						"mode": "managed",
						"type": "aws_instance",
						"name": "unapproved_subnet",
						"provider_config_key": "module.ec2:aws",
						"expressions": {
							"ami": {"constant_value": "ami-0747bdcabd34c712a"},
							"instance_type": {"constant_value": "t2.micro"},
							"subnet_id": {"constant_value": "bad_subnet_id"},
							"tags": {"constant_value": {"Name": "unapproved_subnet"}},
						},
						"schema_version": 1,
					}],
					"variables": {"aws_region": {
						"default": "us-west-2",
						"description": "AWS region",
					}},
				},
			}}},
		},
	}
}

input_ec2_without_subnet := x {
	x := {
		"format_version": "1.1",
		"terraform_version": "1.2.7",
		"planned_values": {"root_module": {"child_modules": [{
			"resources": [{
				"address": "module.ec2.aws_instance.without_subnet",
				"mode": "managed",
				"type": "aws_instance",
				"name": "without_subnet",
				"provider_name": "registry.terraform.io/hashicorp/aws",
				"schema_version": 1,
				"values": {
					"ami": "ami-0747bdcabd34c712a",
					"credit_specification": [],
					"get_password_data": false,
					"hibernation": null,
					"instance_type": "t2.micro",
					"launch_template": [],
					"source_dest_check": true,
					"tags": {"Name": "without_subnet"},
					"tags_all": {"Name": "without_subnet"},
					"timeouts": null,
					"user_data_replace_on_change": false,
					"volume_tags": null,
				},
				"sensitive_values": {
					"capacity_reservation_specification": [],
					"credit_specification": [],
					"ebs_block_device": [],
					"enclave_options": [],
					"ephemeral_block_device": [],
					"ipv6_addresses": [],
					"launch_template": [],
					"maintenance_options": [],
					"metadata_options": [],
					"network_interface": [],
					"private_dns_name_options": [],
					"root_block_device": [],
					"secondary_private_ips": [],
					"security_groups": [],
					"tags": {},
					"tags_all": {},
					"vpc_security_group_ids": [],
				},
			}],
			"address": "module.ec2",
		}]}},
		"resource_changes": [{
			"address": "module.ec2.aws_instance.without_subnet",
			"module_address": "module.ec2",
			"mode": "managed",
			"type": "aws_instance",
			"name": "without_subnet",
			"provider_name": "registry.terraform.io/hashicorp/aws",
			"change": {
				"actions": ["create"],
				"before": null,
				"after": {
					"ami": "ami-0747bdcabd34c712a",
					"credit_specification": [],
					"get_password_data": false,
					"hibernation": null,
					"instance_type": "t2.micro",
					"launch_template": [],
					"source_dest_check": true,
					"tags": {"Name": "without_subnet"},
					"tags_all": {"Name": "without_subnet"},
					"timeouts": null,
					"user_data_replace_on_change": false,
					"volume_tags": null,
				},
				"after_unknown": {
					"arn": true,
					"associate_public_ip_address": true,
					"availability_zone": true,
					"capacity_reservation_specification": true,
					"cpu_core_count": true,
					"cpu_threads_per_core": true,
					"credit_specification": [],
					"disable_api_stop": true,
					"disable_api_termination": true,
					"ebs_block_device": true,
					"ebs_optimized": true,
					"enclave_options": true,
					"ephemeral_block_device": true,
					"host_id": true,
					"host_resource_group_arn": true,
					"iam_instance_profile": true,
					"id": true,
					"instance_initiated_shutdown_behavior": true,
					"instance_state": true,
					"ipv6_address_count": true,
					"ipv6_addresses": true,
					"key_name": true,
					"launch_template": [],
					"maintenance_options": true,
					"metadata_options": true,
					"monitoring": true,
					"network_interface": true,
					"outpost_arn": true,
					"password_data": true,
					"placement_group": true,
					"placement_partition_number": true,
					"primary_network_interface_id": true,
					"private_dns": true,
					"private_dns_name_options": true,
					"private_ip": true,
					"public_dns": true,
					"public_ip": true,
					"root_block_device": true,
					"secondary_private_ips": true,
					"security_groups": true,
					"subnet_id": true,
					"tags": {},
					"tags_all": {},
					"tenancy": true,
					"user_data": true,
					"user_data_base64": true,
					"vpc_security_group_ids": true,
				},
				"before_sensitive": false,
				"after_sensitive": {
					"capacity_reservation_specification": [],
					"credit_specification": [],
					"ebs_block_device": [],
					"enclave_options": [],
					"ephemeral_block_device": [],
					"ipv6_addresses": [],
					"launch_template": [],
					"maintenance_options": [],
					"metadata_options": [],
					"network_interface": [],
					"private_dns_name_options": [],
					"root_block_device": [],
					"secondary_private_ips": [],
					"security_groups": [],
					"tags": {},
					"tags_all": {},
					"vpc_security_group_ids": [],
				},
			},
		}],
		"configuration": {
			"provider_config": {
				"module.ec2:aws": {
					"name": "aws",
					"full_name": "registry.terraform.io/hashicorp/aws",
					"version_constraint": "~> 4.0",
					"module_address": "module.ec2",
					"expressions": {"region": {"references": ["var.aws_region"]}},
				},
				"module.ec2:aws.east": {
					"name": "aws",
					"full_name": "registry.terraform.io/hashicorp/aws",
					"alias": "east",
					"version_constraint": "~> 4.0",
					"module_address": "module.ec2",
					"expressions": {"region": {"constant_value": "us-east-1"}},
				},
			},
			"root_module": {"module_calls": {"ec2": {
				"source": "../../../../../modules/ec2",
				"module": {
					"resources": [{
						"address": "aws_instance.without_subnet",
						"mode": "managed",
						"type": "aws_instance",
						"name": "without_subnet",
						"provider_config_key": "module.ec2:aws",
						"expressions": {
							"ami": {"constant_value": "ami-0747bdcabd34c712a"},
							"instance_type": {"constant_value": "t2.micro"},
							"tags": {"constant_value": {"Name": "without_subnet"}},
						},
						"schema_version": 1,
					}],
					"variables": {"aws_region": {
						"default": "us-west-2",
						"description": "AWS region",
					}},
				},
			}}},
		},
	}
}
