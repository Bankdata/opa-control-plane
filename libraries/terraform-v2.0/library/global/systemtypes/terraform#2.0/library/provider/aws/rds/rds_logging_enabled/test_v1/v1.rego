package global.systemtypes["terraform:2.0"].library.provider.aws.rds.rds_logging_enabled.test_v1

import data.global.systemtypes["terraform:2.0"].library.provider.aws.rds.rds_logging_enabled.v1

test_logging_enabled_for_rds_good {
	accessible := ["audit"]
	in := input_rds_instance(accessible)
	actual := v1.prohibit_rds_instance_with_disabled_logging with input as in
	count(actual) == 0
}

test_logging_enabled_for_rds_empty_array {
	accessible := []
	in := input_rds_instance(accessible)
	actual := v1.prohibit_rds_instance_with_disabled_logging with input as in
	count(actual) == 1
}

test_logging_enabled_for_rds_not_configured {
	accessible := null
	in := input_rds_instance(accessible)
	actual := v1.prohibit_rds_instance_with_disabled_logging with input as in
	count(actual) == 1
}

test_logging_no_enabled_cloudwatch_logs_exports_setting_present {
	in := input_rds_instance_no_cloudwatch_logging_setting
	actual := v1.prohibit_rds_instance_with_disabled_logging with input as in
	count(actual) == 1
}

input_rds_instance(value) = x {
	x := {
		"format_version": "1.1",
		"terraform_version": "1.2.7",
		"planned_values": {"root_module": {"child_modules": [{
			"resources": [{
				"address": "module.sample_rds.aws_db_instance.default",
				"mode": "managed",
				"type": "aws_db_instance",
				"name": "default",
				"provider_name": "registry.terraform.io/hashicorp/aws",
				"schema_version": 1,
				"values": {
					"allocated_storage": 10,
					"allow_major_version_upgrade": null,
					"apply_immediately": false,
					"auto_minor_version_upgrade": true,
					"blue_green_update": [],
					"copy_tags_to_snapshot": false,
					"custom_iam_instance_profile": null,
					"customer_owned_ip_enabled": null,
					"db_name": "mydb",
					"delete_automated_backups": true,
					"deletion_protection": null,
					"domain": null,
					"domain_iam_role_name": null,
					"enabled_cloudwatch_logs_exports": value,
					"engine": "mysql",
					"engine_version": "5.7",
					"final_snapshot_identifier": null,
					"iam_database_authentication_enabled": null,
					"instance_class": "db.t3.micro",
					"max_allocated_storage": null,
					"monitoring_interval": 0,
					"parameter_group_name": "default.mysql5.7",
					"password": "foobarbaz",
					"performance_insights_enabled": false,
					"publicly_accessible": true,
					"replicate_source_db": null,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"security_group_names": null,
					"skip_final_snapshot": true,
					"storage_encrypted": null,
					"tags": null,
					"timeouts": null,
					"username": "foo",
				},
				"sensitive_values": {
					"blue_green_update": [],
					"replicas": [],
					"restore_to_point_in_time": [],
					"s3_import": [],
					"tags_all": {},
					"vpc_security_group_ids": [],
				},
			}],
			"address": "module.sample_rds",
		}]}},
		"resource_changes": [{
			"address": "module.sample_rds.aws_db_instance.default",
			"module_address": "module.sample_rds",
			"mode": "managed",
			"type": "aws_db_instance",
			"name": "default",
			"provider_name": "registry.terraform.io/hashicorp/aws",
			"change": {
				"actions": ["create"],
				"before": null,
				"after": {
					"allocated_storage": 10,
					"allow_major_version_upgrade": null,
					"apply_immediately": false,
					"auto_minor_version_upgrade": true,
					"blue_green_update": [],
					"copy_tags_to_snapshot": false,
					"custom_iam_instance_profile": null,
					"customer_owned_ip_enabled": null,
					"db_name": "mydb",
					"delete_automated_backups": true,
					"deletion_protection": null,
					"domain": null,
					"domain_iam_role_name": null,
					"enabled_cloudwatch_logs_exports": value,
					"engine": "mysql",
					"engine_version": "5.7",
					"final_snapshot_identifier": null,
					"iam_database_authentication_enabled": null,
					"instance_class": "db.t3.micro",
					"max_allocated_storage": null,
					"monitoring_interval": 0,
					"parameter_group_name": "default.mysql5.7",
					"password": "foobarbaz",
					"performance_insights_enabled": false,
					"publicly_accessible": true,
					"replicate_source_db": null,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"security_group_names": null,
					"skip_final_snapshot": true,
					"storage_encrypted": null,
					"tags": null,
					"timeouts": null,
					"username": "foo",
				},
				"after_unknown": {
					"address": true,
					"arn": true,
					"availability_zone": true,
					"backup_retention_period": true,
					"backup_window": true,
					"blue_green_update": [],
					"ca_cert_identifier": true,
					"character_set_name": true,
					"db_subnet_group_name": true,
					"endpoint": true,
					"engine_version_actual": true,
					"hosted_zone_id": true,
					"id": true,
					"identifier": true,
					"identifier_prefix": true,
					"iops": true,
					"kms_key_id": true,
					"latest_restorable_time": true,
					"license_model": true,
					"maintenance_window": true,
					"monitoring_role_arn": true,
					"multi_az": true,
					"name": true,
					"nchar_character_set_name": true,
					"network_type": true,
					"option_group_name": true,
					"performance_insights_kms_key_id": true,
					"performance_insights_retention_period": true,
					"port": true,
					"replica_mode": true,
					"replicas": true,
					"resource_id": true,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"snapshot_identifier": true,
					"status": true,
					"storage_throughput": true,
					"storage_type": true,
					"tags_all": true,
					"timezone": true,
					"vpc_security_group_ids": true,
				},
				"before_sensitive": false,
				"after_sensitive": {
					"blue_green_update": [],
					"password": true,
					"replicas": [],
					"restore_to_point_in_time": [],
					"s3_import": [],
					"tags_all": {},
					"vpc_security_group_ids": [],
				},
			},
		}],
		"configuration": {
			"provider_config": {"module.sample_rds:aws": {
				"name": "aws",
				"full_name": "registry.terraform.io/hashicorp/aws",
				"version_constraint": "~> 4.0",
				"module_address": "module.sample_rds",
				"expressions": {"region": {"references": ["var.aws_region"]}},
			}},
			"root_module": {"module_calls": {"sample_rds": {
				"source": "../../../../../modules/rds",
				"module": {
					"resources": [{
						"address": "aws_db_instance.default",
						"mode": "managed",
						"type": "aws_db_instance",
						"name": "default",
						"provider_config_key": "module.sample_rds:aws",
						"expressions": {
							"allocated_storage": {"constant_value": 10},
							"db_name": {"constant_value": "mydb"},
							"engine": {"constant_value": "mysql"},
							"engine_version": {"constant_value": "5.7"},
							"instance_class": {"constant_value": "db.t3.micro"},
							"parameter_group_name": {"constant_value": "default.mysql5.7"},
							"password": {"constant_value": "foobarbaz"},
							"publicly_accessible": {"constant_value": true},
							"skip_final_snapshot": {"constant_value": true},
							"username": {"constant_value": "foo"},
						},
						"schema_version": 1,
					}],
					"variables": {"aws_region": {
						"default": "us-west-2",
						"description": "AWS region",
					}},
				},
			}}},
		},
	}
}

input_rds_instance_no_cloudwatch_logging_setting := x {
	x := {
		"format_version": "1.1",
		"terraform_version": "1.2.7",
		"planned_values": {"root_module": {"child_modules": [{
			"resources": [{
				"address": "module.sample_rds.aws_db_instance.default",
				"mode": "managed",
				"type": "aws_db_instance",
				"name": "default",
				"provider_name": "registry.terraform.io/hashicorp/aws",
				"schema_version": 1,
				"values": {
					"allocated_storage": 10,
					"allow_major_version_upgrade": null,
					"apply_immediately": false,
					"auto_minor_version_upgrade": true,
					"blue_green_update": [],
					"copy_tags_to_snapshot": false,
					"custom_iam_instance_profile": null,
					"customer_owned_ip_enabled": null,
					"db_name": "mydb",
					"delete_automated_backups": true,
					"deletion_protection": null,
					"domain": null,
					"domain_iam_role_name": null,
					"engine": "mysql",
					"engine_version": "5.7",
					"final_snapshot_identifier": null,
					"iam_database_authentication_enabled": null,
					"instance_class": "db.t3.micro",
					"max_allocated_storage": null,
					"monitoring_interval": 0,
					"parameter_group_name": "default.mysql5.7",
					"password": "foobarbaz",
					"performance_insights_enabled": false,
					"publicly_accessible": true,
					"replicate_source_db": null,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"security_group_names": null,
					"skip_final_snapshot": true,
					"storage_encrypted": null,
					"tags": null,
					"timeouts": null,
					"username": "foo",
				},
				"sensitive_values": {
					"blue_green_update": [],
					"replicas": [],
					"restore_to_point_in_time": [],
					"s3_import": [],
					"tags_all": {},
					"vpc_security_group_ids": [],
				},
			}],
			"address": "module.sample_rds",
		}]}},
		"resource_changes": [{
			"address": "module.sample_rds.aws_db_instance.default",
			"module_address": "module.sample_rds",
			"mode": "managed",
			"type": "aws_db_instance",
			"name": "default",
			"provider_name": "registry.terraform.io/hashicorp/aws",
			"change": {
				"actions": ["create"],
				"before": null,
				"after": {
					"allocated_storage": 10,
					"allow_major_version_upgrade": null,
					"apply_immediately": false,
					"auto_minor_version_upgrade": true,
					"blue_green_update": [],
					"copy_tags_to_snapshot": false,
					"custom_iam_instance_profile": null,
					"customer_owned_ip_enabled": null,
					"db_name": "mydb",
					"delete_automated_backups": true,
					"deletion_protection": null,
					"domain": null,
					"domain_iam_role_name": null,
					"engine": "mysql",
					"engine_version": "5.7",
					"final_snapshot_identifier": null,
					"iam_database_authentication_enabled": null,
					"instance_class": "db.t3.micro",
					"max_allocated_storage": null,
					"monitoring_interval": 0,
					"parameter_group_name": "default.mysql5.7",
					"password": "foobarbaz",
					"performance_insights_enabled": false,
					"publicly_accessible": true,
					"replicate_source_db": null,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"security_group_names": null,
					"skip_final_snapshot": true,
					"storage_encrypted": null,
					"tags": null,
					"timeouts": null,
					"username": "foo",
				},
				"after_unknown": {
					"address": true,
					"arn": true,
					"availability_zone": true,
					"backup_retention_period": true,
					"backup_window": true,
					"blue_green_update": [],
					"ca_cert_identifier": true,
					"character_set_name": true,
					"db_subnet_group_name": true,
					"endpoint": true,
					"engine_version_actual": true,
					"hosted_zone_id": true,
					"id": true,
					"identifier": true,
					"identifier_prefix": true,
					"iops": true,
					"kms_key_id": true,
					"latest_restorable_time": true,
					"license_model": true,
					"maintenance_window": true,
					"monitoring_role_arn": true,
					"multi_az": true,
					"name": true,
					"nchar_character_set_name": true,
					"network_type": true,
					"option_group_name": true,
					"performance_insights_kms_key_id": true,
					"performance_insights_retention_period": true,
					"port": true,
					"replica_mode": true,
					"replicas": true,
					"resource_id": true,
					"restore_to_point_in_time": [],
					"s3_import": [],
					"snapshot_identifier": true,
					"status": true,
					"storage_throughput": true,
					"storage_type": true,
					"tags_all": true,
					"timezone": true,
					"vpc_security_group_ids": true,
				},
				"before_sensitive": false,
				"after_sensitive": {
					"blue_green_update": [],
					"password": true,
					"replicas": [],
					"restore_to_point_in_time": [],
					"s3_import": [],
					"tags_all": {},
					"vpc_security_group_ids": [],
				},
			},
		}],
		"configuration": {
			"provider_config": {"module.sample_rds:aws": {
				"name": "aws",
				"full_name": "registry.terraform.io/hashicorp/aws",
				"version_constraint": "~> 4.0",
				"module_address": "module.sample_rds",
				"expressions": {"region": {"references": ["var.aws_region"]}},
			}},
			"root_module": {"module_calls": {"sample_rds": {
				"source": "../../../../../modules/rds",
				"module": {
					"resources": [{
						"address": "aws_db_instance.default",
						"mode": "managed",
						"type": "aws_db_instance",
						"name": "default",
						"provider_config_key": "module.sample_rds:aws",
						"expressions": {
							"allocated_storage": {"constant_value": 10},
							"db_name": {"constant_value": "mydb"},
							"engine": {"constant_value": "mysql"},
							"engine_version": {"constant_value": "5.7"},
							"instance_class": {"constant_value": "db.t3.micro"},
							"parameter_group_name": {"constant_value": "default.mysql5.7"},
							"password": {"constant_value": "foobarbaz"},
							"publicly_accessible": {"constant_value": true},
							"skip_final_snapshot": {"constant_value": true},
							"username": {"constant_value": "foo"},
						},
						"schema_version": 1,
					}],
					"variables": {"aws_region": {
						"default": "us-west-2",
						"description": "AWS region",
					}},
				},
			}}},
		},
	}
}
