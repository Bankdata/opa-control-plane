package global.systemtypes["terraform:2.0"].library.provider.aws.s3.unencrypted_bucket_object.test_v1

import data.global.systemtypes["terraform:2.0"].library.provider.aws.s3.unencrypted_bucket_object.v1

test_unencrypted_s3_bucket_objects_good {
	config_patch1 := {
		"op": "add",
		"path": "/resource_changes/1/change/after/server_side_encryption",
		"value": "aws:kms",
	}
	config_patch2 := {
		"op": "add",
		"path": "/resource_changes/2/change/after/server_side_encryption",
		"value": "aws:kms",
	}

	input_data = json.patch(input_with_s3_bucket_object_resource, [config_patch1, config_patch2])
	actual := v1.unencrypted_s3_bucket_object with input as input_data

	count(actual) == 0
}

test_unencrypted_s3_bucket_objects_bad {
	input_data := input_with_s3_bucket_object_resource
	actual := v1.unencrypted_s3_bucket_object with input as input_data

	count(actual) == 2
}

input_with_s3_bucket_object_resource := {
	"format_version": "1.1",
	"terraform_version": "1.2.3",
	"planned_values": {"root_module": {"resources": [
		{
			"address": "aws_s3_bucket.examplebucket",
			"mode": "managed",
			"type": "aws_s3_bucket",
			"name": "examplebucket",
			"provider_name": "registry.terraform.io/hashicorp/aws",
			"schema_version": 0,
			"values": {
				"acl": "private",
				"bucket": "examplebuckettftest",
				"bucket_prefix": null,
				"force_destroy": false,
				"tags": null,
				"timeouts": null,
			},
			"sensitive_values": {
				"cors_rule": [],
				"grant": [],
				"lifecycle_rule": [],
				"logging": [],
				"object_lock_configuration": [],
				"replication_configuration": [],
				"server_side_encryption_configuration": [],
				"tags_all": {},
				"versioning": [],
				"website": [],
			},
		},
		{
			"address": "aws_s3_bucket_object.examplebucket_object",
			"mode": "managed",
			"type": "aws_s3_bucket_object",
			"name": "examplebucket_object",
			"provider_name": "registry.terraform.io/hashicorp/aws",
			"schema_version": 0,
			"values": {
				"acl": "private",
				"cache_control": null,
				"content": null,
				"content_base64": null,
				"content_disposition": null,
				"content_encoding": null,
				"content_language": null,
				"force_destroy": false,
				"key": "someobject1",
				"metadata": null,
				"object_lock_legal_hold_status": null,
				"object_lock_mode": null,
				"object_lock_retain_until_date": null,
				"server_side_encryption": "aws:kms",
				"source": "index.html",
				"source_hash": null,
				"tags": null,
				"website_redirect": null,
			},
			"sensitive_values": {"tags_all": {}},
		},
		{
			"address": "aws_s3_object.examplebucket_object",
			"mode": "managed",
			"type": "aws_s3_object",
			"name": "examplebucket_object",
			"provider_name": "registry.terraform.io/hashicorp/aws",
			"schema_version": 0,
			"values": {
				"acl": "private",
				"cache_control": null,
				"content": null,
				"content_base64": null,
				"content_disposition": null,
				"content_encoding": null,
				"content_language": null,
				"force_destroy": false,
				"key": "someobject2",
				"metadata": null,
				"object_lock_legal_hold_status": null,
				"object_lock_mode": null,
				"object_lock_retain_until_date": null,
				"server_side_encryption": "aws:kms",
				"source": "index.html",
				"source_hash": null,
				"tags": null,
				"website_redirect": null,
			},
			"sensitive_values": {"tags_all": {}},
		},
	]}},
	"resource_changes": [
		{
			"address": "aws_s3_bucket.examplebucket",
			"mode": "managed",
			"type": "aws_s3_bucket",
			"name": "examplebucket",
			"provider_name": "registry.terraform.io/hashicorp/aws",
			"change": {
				"actions": ["create"],
				"before": null,
				"after": {
					"acl": "private",
					"bucket": "examplebuckettftest",
					"bucket_prefix": null,
					"force_destroy": false,
					"tags": null,
					"timeouts": null,
				},
				"after_unknown": {
					"acceleration_status": true,
					"arn": true,
					"bucket_domain_name": true,
					"bucket_regional_domain_name": true,
					"cors_rule": true,
					"grant": true,
					"hosted_zone_id": true,
					"id": true,
					"lifecycle_rule": true,
					"logging": true,
					"object_lock_configuration": true,
					"object_lock_enabled": true,
					"policy": true,
					"region": true,
					"replication_configuration": true,
					"request_payer": true,
					"server_side_encryption_configuration": true,
					"tags_all": true,
					"versioning": true,
					"website": true,
					"website_domain": true,
					"website_endpoint": true,
				},
				"before_sensitive": false,
				"after_sensitive": {
					"cors_rule": [],
					"grant": [],
					"lifecycle_rule": [],
					"logging": [],
					"object_lock_configuration": [],
					"replication_configuration": [],
					"server_side_encryption_configuration": [],
					"tags_all": {},
					"versioning": [],
					"website": [],
				},
			},
		},
		{
			"address": "aws_s3_bucket_object.examplebucket_object",
			"mode": "managed",
			"type": "aws_s3_bucket_object",
			"name": "examplebucket_object",
			"provider_name": "registry.terraform.io/hashicorp/aws",
			"change": {
				"actions": ["create"],
				"before": null,
				"after": {
					"acl": "private",
					"cache_control": null,
					"content": null,
					"content_base64": null,
					"content_disposition": null,
					"content_encoding": null,
					"content_language": null,
					"force_destroy": false,
					"key": "someobject1",
					"metadata": null,
					"object_lock_legal_hold_status": null,
					"object_lock_mode": null,
					"object_lock_retain_until_date": null,
					"source": "index.html",
					"source_hash": null,
					"tags": null,
					"website_redirect": null,
				},
				"after_unknown": {
					"bucket": true,
					"bucket_key_enabled": true,
					"content_type": true,
					"etag": true,
					"id": true,
					"kms_key_id": true,
					"storage_class": true,
					"tags_all": true,
					"version_id": true,
				},
				"before_sensitive": false,
				"after_sensitive": {"tags_all": {}},
			},
		},
		{
			"address": "aws_s3_object.examplebucket_object",
			"mode": "managed",
			"type": "aws_s3_object",
			"name": "examplebucket_object",
			"provider_name": "registry.terraform.io/hashicorp/aws",
			"change": {
				"actions": ["create"],
				"before": null,
				"after": {
					"acl": "private",
					"cache_control": null,
					"content": null,
					"content_base64": null,
					"content_disposition": null,
					"content_encoding": null,
					"content_language": null,
					"force_destroy": false,
					"key": "someobject2",
					"metadata": null,
					"object_lock_legal_hold_status": null,
					"object_lock_mode": null,
					"object_lock_retain_until_date": null,
					"source": "index.html",
					"source_hash": null,
					"tags": null,
					"website_redirect": null,
				},
				"after_unknown": {
					"bucket": true,
					"bucket_key_enabled": true,
					"content_type": true,
					"etag": true,
					"id": true,
					"kms_key_id": true,
					"storage_class": true,
					"tags_all": true,
					"version_id": true,
				},
				"before_sensitive": false,
				"after_sensitive": {"tags_all": {}},
			},
		},
	],
	"configuration": {
		"provider_config": {"aws": {
			"name": "aws",
			"full_name": "registry.terraform.io/hashicorp/aws",
			"expressions": {"region": {"constant_value": "us-east-1"}},
		}},
		"root_module": {"resources": [
			{
				"address": "aws_s3_bucket.examplebucket",
				"mode": "managed",
				"type": "aws_s3_bucket",
				"name": "examplebucket",
				"provider_config_key": "aws",
				"expressions": {
					"acl": {"constant_value": "private"},
					"bucket": {"constant_value": "examplebuckettftest"},
				},
				"schema_version": 0,
			},
			{
				"address": "aws_s3_bucket_object.examplebucket_object",
				"mode": "managed",
				"type": "aws_s3_bucket_object",
				"name": "examplebucket_object",
				"provider_config_key": "aws",
				"expressions": {
					"bucket": {"references": [
						"aws_s3_bucket.examplebucket.id",
						"aws_s3_bucket.examplebucket",
					]},
					"key": {"constant_value": "someobject1"},
					"server_side_encryption": {"constant_value": "aws:kms"},
					"source": {"constant_value": "index.html"},
				},
				"schema_version": 0,
			},
			{
				"address": "aws_s3_object.examplebucket_object",
				"mode": "managed",
				"type": "aws_s3_object",
				"name": "examplebucket_object",
				"provider_config_key": "aws",
				"expressions": {
					"bucket": {"references": [
						"aws_s3_bucket.examplebucket.id",
						"aws_s3_bucket.examplebucket",
					]},
					"key": {"constant_value": "someobject2"},
					"server_side_encryption": {"constant_value": "aws:kms"},
					"source": {"constant_value": "index.html"},
				},
				"schema_version": 0,
			},
		]},
	},
	"relevant_attributes": [{
		"resource": "aws_s3_bucket.examplebucket",
		"attribute": ["id"],
	}],
}
